#!/bin/bash
#wget https://github.com/${GitUser}/
GitUser="KhaiVpn767"
# Color Validation
Yellow='\e[0;33m'
green='\e[0;32m'
RED='\033[0;31m'
NC='\033[0m'
BGBLUE='\e[1;44m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\e[0m'
MYIP=$(curl -sS ipv4.icanhazip.com)
echo -e "\e[32mloading...\e[0m"
clear
# Valid Script
VALIDITY() {
    today=$(date -d "0 days" +"%Y-%m-%d")
    Exp1=$(curl -s https://raw.githubusercontent.com/KhaiVpn767/allow/main/ipvps.conf | grep $MYIP | awk '{print $4}')
    if [[ $today < $Exp1 ]]; then
        echo -e "\e[32mYOUR SCRIPT ACTIVE..\e[0m"
    else
        echo -e "\e[31mYOUR SCRIPT HAS EXPIRED!\e[0m"
        echo -e "\e[31mPlease renew your ipvps first\e[0m"
        exit 0
    fi
}
IZIN=$(curl -s https://raw.githubusercontent.com/KhaiVpn767/allow/main/ipvps.conf | awk '{print $5}' | grep $MYIP)
if [ $MYIP = $IZIN ]; then
    echo -e "\e[32mPermission Accepted...\e[0m"
    VALIDITY
else
    echo -e "\e[31mPermission Denied!\e[0m"
    echo -e "\e[31mPlease buy script first\e[0m"
    exit 0
fi

echo -e "\e[32mloading...\e[0m"
clear
IP=$(wget -qO- icanhazip.com)
dateToday=$(date +"%Y-%m-%d")
Name=$(curl -s https://raw.githubusercontent.com/KhaiVpn767/allow/main/ipvps.conf | grep $MYIP | awk '{print $2}')

setup_bot() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    echo "Pergi ke @BotFather dan type /newbot untuk membuat bot baru"
    echo "Pergi ke @MissRose_bot dan type /id untuk mendapatkan ID telegram"
    echo ""
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch $switch" >>/root/.bckupbot
    read -n 1 -s -r -p "Press any key to back on Bot menu"
    botbckpBot_menu
}

botBackup() {
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    adminid=$(sed -n '2p' /root/.bckupbot | awk '{print $1}')
    echo -e "[ ${green}INFO${NC} ] • Create password for database"
    read -t 10 -p "Enter password : " InputPass
    if [[ -z $InputPass ]]; then
        InputPass="khaivpnking"
    fi
    sleep 1
    echo -e "[ ${green}INFO${NC} ] • VPS Data Backup... "
    mkdir /root/backup &>/dev/null
    cp /etc/passwd backup/ &>/dev/null
    cp /etc/group backup/ &>/dev/null
    cp /etc/shadow backup/ &>/dev/null
    cp /etc/gshadow backup/ &>/dev/null
    cp -r /var/lib/premium-script/ backup/premium-script &>/dev/null
    cp -r /usr/local/etc/xray backup/xray &>/dev/null
    cp -r /home/vps/public_html backup/public_html &>/dev/null
    cd /root &>/dev/null
    zip -rP "$InputPass" "$IP.zip" backup >/dev/null 2>&1
    echo -e "[ ${green}INFO${NC} ] • Sending Via Bot... "
    curl -Ss --request POST \
        --url "https://api.telegram.org/bot${bottoken}/sendDocument" \
        --header 'Content-Type: multipart/form-data' \
        --form "chat_id=${adminid}" \
        --form "caption=Here Your Backup Today: ${dateToday}" \
        --form "document=@/root/${IP}.zip" >/root/t1
    rm -rf /root/backup
    rm -r /root/$IP.zip
    rm -f /root/t1
    read -n 1 -s -r -p "Press any key to back on menu"
    botbckpBot_menu
}

restoreBot() {
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    read -p "File ID   : " fileId
    read -p "File PATH : " filePath
    curl -Ss --request GET \
        --url "https://api.telegram.org/file/bot${bottoken}/${filePath}?file_id=${fileId}" >backup.zip
    read -rp "Password File: " InputPass
    unzip -P $InputPass /root/backup.zip &>/dev/null
    cd /root/backup
    cp passwd /etc/ &>/dev/null
    cp group /etc/ &>/dev/null
    cp shadow /etc/ &>/dev/null
    cp gshadow /etc/ &>/dev/null
    cp -r premium-script /var/lib/ &>/dev/null
    cp -r xray /usr/local/etc/ &>/dev/null
    cp -r public_html /home/vps/ &>/dev/null
    rm -rf /root/backup
    rm -f backup.zip
    read -n 1 -s -r -p "Press any key to back on menu"
    menu
}

restoreLink() {
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    read -p "File Url   : " file_url
    wget -O /root/backup.zip "$file_url"
    read -rp "Password File: " InputPass
    unzip -P $InputPass /root/backup.zip &>/dev/null
    cd /root/backup
    cp passwd /etc/ &>/dev/null
    cp group /etc/ &>/dev/null
    cp shadow /etc/ &>/dev/null
    cp gshadow /etc/ &>/dev/null
    cp -r premium-script /var/lib/ &>/dev/null
    cp -r xray /usr/local/etc/ &>/dev/null
    cp -r public_html /home/vps/ &>/dev/null
    rm -rf /root/backup
    rm -f backup.zip
    read -n 1 -s -r -p "Press any key to back on menu"
    menu
}

autoBackup() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    if [ "${switch}" == "on" ]; then
        sed -i 's/switch on/switch off/g' /root/.bckupbot
        sed -i "/autobackup/d" /etc/crontab
        service cron restart >/dev/null 2>&1
        service cron reload >/dev/null 2>&1
        echo "Turn Off"
    else
        sed -i 's/switch off/switch on/g' /root/.bckupbot
        timeNow=$(grep -i "time" /root/.bckupbot | awk '{print $2}')
        hour=$(echo $timeNow | cut -d: -f1)
        min=$(echo $timeNow | cut -d: -f2)
        [ -z "$hour" ] && hour=0
        [ -z "$min" ] && min=5
        echo "$min $hour * * * root autobackup" >>/etc/crontab
        service cron restart >/dev/null 2>&1
        service cron reload >/dev/null 2>&1
        echo "Turn On"
    fi
    sleep 1
    read -n 1 -s -r -p "Press any key to back on Bot menu"
    botbckpBot_menu
}

changeBackupTime() {
    clear
    echo -e "${CYAN}Tukar Waktu Auto Backup${NC}"
    echo "------------------------------------"
    read -p "Masukkan jam (00-23): " jam
    read -p "Masukkan minit (00-59): " min
    if [[ ! $jam =~ ^([0-1]?[0-9]|2[0-3])$ ]] || [[ ! $min =~ ^([0-5]?[0-9])$ ]]; then
        echo -e "${RED}Ralat: Masa tidak sah!${NC}"
        sleep 2
        botbckpBot_menu
        return
    fi
    if grep -q "time" /root/.bckupbot; then
        sed -i "/^time/d" /root/.bckupbot
    fi
    echo "time ${jam}:${min}" >> /root/.bckupbot
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    if [ "$switch" == "on" ]; then
        sed -i "/autobackup/d" /etc/crontab
        echo "${min} ${jam} * * * root autobackup" >> /etc/crontab
        service cron restart >/dev/null 2>&1
        service cron reload >/dev/null 2>&1
        echo -e "${green}Auto backup masa telah dikemas kini ke ${jam}:${min}${NC}"
    else
        echo -e "${yellow}Masa disimpan (${jam}:${min}), tetapi auto backup masih OFF.${NC}"
    fi
    read -n 1 -s -r -p "Tekan sebarang kekunci untuk kembali ke menu"
    botbckpBot_menu
}

botbckpBot_menu() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    timeNow=$(grep -i "time" /root/.bckupbot | awk '{print $2}')
    clear
    if [ "${switch}" == "on" ]; then
        sts="\033[0;32m[On]\033[0m"
    else
        sts="\033[1;31m[Off]\033[0m"
    fi
    echo -e "\033[0;34m══════════════════════════════════════════════════════\033[0m"
    echo -e "\\E[0;44;37m               Telegram Bot (AutoBackup)              \\E[0m"
    echo -e "\033[0;34m══════════════════════════════════════════════════════\033[0m"
    echo -e "$green VPS Data Backup By khaiVPN"
    echo -e "$green Telegram : https://t.me/khaivpn / @khaivpn"
    echo -e ""
    echo -e " $green Status AutoBackup : $sts"
    echo -e " $green Waktu AutoBackup  : ${timeNow:-05:00}${NC}"
    echo -e " $green [•1 ]${NC} $CYAN Setup Bot Telegram \e[0m"
    echo -e " $green [•2 ]${NC} $CYAN Auto Backup Status \e[0m"
    echo -e " $green [•3 ]${NC} $CYAN Backup VPS (Telegram Bot) \e[0m"
    echo -e " $green [•4 ]${NC} $CYAN Restore Data [URL]\e[0m"
    echo -e " $green [•5 ]${NC} $CYAN Restore Data \e[0m"
    echo -e " $green [•6 ]${NC} $CYAN Tukar Waktu Auto Backup \e[0m"
    echo -e "\033[0;34m══════════════════════════════════════════════════════\033[0m"
    echo -e "\\E[0;44;37m          x)   MENU                                   \\E[0m"
    echo -e "\033[0;34m══════════════════════════════════════════════════════\033[0m"
    echo -ne "Select From Options [ 1-6 or x ] : "
    read botch
    case "$botch" in
    1) clear; setup_bot ;;
    2) clear; autoBackup ;;
    3) clear; botBackup ;;
    4) clear; restoreLink ;;
    5) clear; restoreBot ;;
    6) clear; changeBackupTime ;;
    x) menu ;;
    *) echo "Please enter a correct number"; sleep 1; botbckpBot_menu ;;
    esac
}

clear
[[ ! -f /root/.bckupbot ]] && {
    echo "Please Input Bot Details First"
    sleep 2
    clear
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch off" >>/root/.bckupbot
}
read -t 5 -p "Backup y/n?  " directBckp
if [ "${directBckp}" == "n" ]; then
    botbckpBot_menu
else
    botBackup
fi
