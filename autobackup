#!/bin/bash
#wget https://github.com/${GitUser}/
GitUser="KhaiVpn767"
# Warna
Yellow='\e[0;33m'
green='\e[0;32m'
RED='\033[0;31m'
NC='\033[0m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MYIP=$(curl -sS ipv4.icanhazip.com)
clear
echo -e "${green}Loading...${NC}"

# Validasi
VALIDITY() {
    today=$(date -d "0 days" +"%Y-%m-%d")
    Exp1=$(curl -s https://raw.githubusercontent.com/KhaiVpn767/allow/main/ipvps.conf | grep $MYIP | awk '{print $4}')
    if [[ $today < $Exp1 ]]; then
        echo -e "${green}SCRIPT ACTIVE${NC}"
    else
        echo -e "${RED}SCRIPT EXPIRED!${NC}"
        exit 0
    fi
}
IZIN=$(curl -s https://raw.githubusercontent.com/KhaiVpn767/allow/main/ipvps.conf | awk '{print $5}' | grep $MYIP)
if [ $MYIP = $IZIN ]; then
    echo -e "${green}Permission Accepted${NC}"
    VALIDITY
else
    echo -e "${RED}Permission Denied${NC}"
    exit 0
fi

IP=$(wget -qO- icanhazip.com)
dateToday=$(date +"%Y-%m-%d")

# === Tambahan baru: Tukar Waktu Auto Backup ===
changeBackupTime() {
    clear
    echo -e "${CYAN}Tukar Waktu Auto Backup${NC}"
    echo "------------------------------------"
    read -p "Masukkan jam (00-23): " jam
    read -p "Masukkan minit (00-59): " min

    if [[ ! $jam =~ ^([0-1]?[0-9]|2[0-3])$ ]] || [[ ! $min =~ ^([0-5]?[0-9])$ ]]; then
        echo -e "${RED}Ralat: Masa tidak sah!${NC}"
        sleep 2
        botbckpBot_menu
        return
    fi

    # Simpan masa baru dalam /root/.bckupbot
    sed -i '/^time/d' /root/.bckupbot 2>/dev/null
    echo "time ${jam}:${min}" >> /root/.bckupbot

    # Dapatkan lokasi sebenar script untuk cron
    SCRIPT_PATH=$(realpath "$0")

    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    if [ "$switch" == "on" ]; then
        sed -i '/autobackup/d' /etc/crontab
        echo "${min} ${jam} * * * root bash ${SCRIPT_PATH}" >> /etc/crontab
        service cron restart >/dev/null 2>&1
        echo -e "${green}Waktu auto backup telah ditukar ke ${jam}:${min}${NC}"
    else
        echo -e "${yellow}Masa disimpan (${jam}:${min}), tetapi auto backup masih OFF.${NC}"
    fi
    read -n 1 -s -r -p "Tekan sebarang kekunci untuk kembali ke menu"
    botbckpBot_menu
}

# === Fungsi asal (dipendekkan) ===
setup_bot() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch $switch" >>/root/.bckupbot
    read -n 1 -s -r -p "Press any key to back on Bot menu"
    botbckpBot_menu
}

botBackup() {
    bottoken=$(sed -n '1p' /root/.bckupbot)
    adminid=$(sed -n '2p' /root/.bckupbot)
    mkdir -p /root/backup
    cp /etc/passwd /root/backup/
    cp /etc/group /root/backup/
    cp /etc/shadow /root/backup/
    cp /etc/gshadow /root/backup/
    cp -r /usr/local/etc/xray /root/backup/xray &>/dev/null
    cd /root && zip -r $IP.zip backup >/dev/null 2>&1
    curl -s -F chat_id="$adminid" -F document=@"/root/${IP}.zip" https://api.telegram.org/bot${bottoken}/sendDocument
    rm -rf /root/backup /root/${IP}.zip
    read -n 1 -s -r -p "Press any key to back on menu"
    botbckpBot_menu
}

autoBackup() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    SCRIPT_PATH=$(realpath "$0")
    if [ "${switch}" == "on" ]; then
        sed -i 's/switch on/switch off/g' /root/.bckupbot
        sed -i '/autobackup/d' /etc/crontab
        service cron restart >/dev/null 2>&1
        echo "Turn Off"
    else
        sed -i 's/switch off/switch on/g' /root/.bckupbot
        timeNow=$(grep -i "time" /root/.bckupbot | awk '{print $2}')
        hour=$(echo $timeNow | cut -d: -f1)
        min=$(echo $timeNow | cut -d: -f2)
        [ -z "$hour" ] && hour=0
        [ -z "$min" ] && min=5
        sed -i '/autobackup/d' /etc/crontab
        echo "$min $hour * * * root bash ${SCRIPT_PATH}" >> /etc/crontab
        service cron restart >/dev/null 2>&1
        echo "Turn On"
    fi
    read -n 1 -s -r -p "Press any key to back on menu"
    botbckpBot_menu
}

botbckpBot_menu() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    timeNow=$(grep -i "time" /root/.bckupbot | awk '{print $2}')
    clear
    [ -z "$timeNow" ] && timeNow="05:00"
    if [ "$switch" == "on" ]; then
        sts="${green}[On]${NC}"
    else
        sts="${RED}[Off]${NC}"
    fi
    echo -e "${BLUE}══════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}          Telegram Bot (AutoBackup)${NC}"
    echo -e "${BLUE}══════════════════════════════════════════════════════${NC}"
    echo -e " Status AutoBackup : $sts"
    echo -e " Waktu AutoBackup  : $timeNow"
    echo -e ""
    echo -e " [•1] Setup Bot Telegram"
    echo -e " [•2] Auto Backup Status"
    echo -e " [•3] Backup VPS (Telegram Bot)"
    echo -e " [•4] Restore Data [URL]"
    echo -e " [•5] Restore Data"
    echo -e " [•6] Tukar Waktu Auto Backup"
    echo -e "${BLUE}══════════════════════════════════════════════════════${NC}"
    echo -ne "Select [1-6 or x]: "
    read opt
    case $opt in
        1) setup_bot ;;
        2) autoBackup ;;
        3) botBackup ;;
        6) changeBackupTime ;;
        x) clear; exit ;;
        *) botbckpBot_menu ;;
    esac
}

clear
[[ ! -f /root/.bckupbot ]] && {
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch off" >>/root/.bckupbot
}
read -t 5 -p "Backup y/n? " choice
if [ "$choice" == "y" ]; then
    botBackup
else
    botbckpBot_menu
fi
